# SCAL3 with CTAP2

**Author:** [Sander Dijkhuis](mailto:sander.dijkhuis@cleverbase.com) ([Cleverbase](https://cleverbase.com/en/)) \
**License:** [Creative Commons Attribution 4.0 International](https://creativecommons.org/licenses/by/4.0/)

This document introduces the SCAL3 with CTAP2 scheme, a scheme to meet the [SCAL3 requirements](../../README.md) based on the [FIDO Client to Authenticator Protocol version 2 (CTAP2)](https://fidoalliance.org/specifications-overview/). With this solution, subscribers can deploy a FIDO CTAP2 authenticator with PIN protection, such as a [YubiKey](https://en.wikipedia.org/wiki/YubiKey), as a [Multi-Factor Cryptographic Device](https://pages.nist.gov/800-63-3/sp800-63b.html#mfcd).

To map terminology from the [SCAL3 introduction](../../README.md):

- **device**: a CTAP2 authenticator
- **subscriber**: user interacting with the device using a CTAP2 client, enrolling with a local authentication mechanism such as PIN verification
- **tamper-evident log**: a transparency log or *tlog*
- **central system**: typically is a HSM-backed service for managing encryption and/or signing keys for the subscriber

## Technical details

### Log record format

Each tlog record is based on an authenticator assertion based on client data. This specification assumes that the authenticator signs using an ECDSA key pair that was attested to the provider during enrollment.

```
<number> || <timestamp> || <nonce> || <authenticator> || <signature> || <instruction>
```

- `number`: log sequence number, maintained between subscriber and provider (4 bytes, see below)
- `timestamp`: timestamp generated by the provider (8 bytes)
- `nonce`: random challenge number to be used once, generated by the provider (8 bytes)
- `authenticator`: authenticator data as per CTAP2
- `signature`: authenticator assertion `ecdsa(<authenticator> || sha256(<client_data>))` as per CTAP2
  - `client_data`: `<key> || <timestamp> || <nonce> || <instruction>`
- `instruction`: HSM-backed key management instruction, generated by the subscriber

### Log sequence number

The 4-byte log sequence `number` is a big-endian encoded strictly increasing number starting at 0 upon enrollment of a subscriber.

Using these numbers, the subscriber and provider can verify integrity of the protected tlog.

Optionally, the numbers may be encrypted in such a way that the subscriber can share records without disclosing the amount of previously recorded instructions.

### Authentication protocol

1. Provider determines `key` and `timestamp`.
2. Provider generates `nonce`.
3. Provider shares `key`, `timestamp` and `nonce` with Subscriber in a challenge.
4. Subscriber determines `instruction` and `client_data`.
5. Subscriber creates `authenticator` and `signature` using their authenticator.
6. Subscriber responds to Provider with the results.
7. Provider validates the input and verifies the signatures.
8. Provider writes the record to the protected tlog.

After successful authentication and subsequent authorization, Provider executes `instruction` and returns the result.

## Acknowledgements

The usage of a log sequence number shared between the subscriber and provider is inspired by the [NL Wallet Solution Architecture v1.0.3 draft](https://edi.pleio.nl/files/view/dc585f22-ca66-4892-87c5-c7bdb2dd69b4/nlw-solution-architecture-sad-v1.pdf) by [MinBZK](https://github.com/MinBZK).
